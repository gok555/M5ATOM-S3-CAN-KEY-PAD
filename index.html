<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>M5AtomS3 CAN Remote</title>
<style>
  body { font-family: sans-serif; padding: 20px; }
  button { margin: 5px; padding: 15px; font-size: 20px; }
  #log { margin-top: 20px; white-space: pre-line; }
</style>
</head>
<body>

<h2>ğŸ”µ BLEæ¥ç¶š</h2>
<button id="btnConnect">BLEæ¥ç¶šã™ã‚‹</button>

<h3>CAN 8ãƒœã‚¿ãƒ³</h3>
<div>
  <button class="txbtn" data-id="1">BTN1</button>
  <button class="txbtn" data-id="2">BTN2</button>
  <button class="txbtn" data-id="3">BTN3</button>
  <button class="txbtn" data-id="4">BTN4</button>
  <button class="txbtn" data-id="5">BTN5</button>
  <button class="txbtn" data-id="6">BTN6</button>
  <button class="txbtn" data-id="7">BTN7</button>
  <button class="txbtn" data-id="8">BTN8</button>
</div>

<h3>ãƒ­ã‚°</h3>
<div id="log">ğŸ”ºBLEæœªæ¥ç¶š</div>

<script>
const UART_SERVICE = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
const UART_TX      = "6e400003-b5a3-f393-e0a9-e50e24dcca9e";
const UART_RX      = "6e400002-b5a3-f393-e0a9-e50e24dcca9e";

let device, server, service;
let txChar, rxChar;

function log(msg) {
  document.getElementById("log").textContent += "\n" + msg;
  console.log(msg);
}

document.getElementById("btnConnect").onclick = async () => {
  try {
    log("ğŸ” ãƒ‡ãƒã‚¤ã‚¹æ¤œç´¢ä¸­...");

    device = await navigator.bluetooth.requestDevice({
      filters: [{ services: [UART_SERVICE] }]
    });

    log("ğŸ”— æ¥ç¶šä¸­: " + device.name);
    device.addEventListener("gattserverdisconnected", () => {
      log("âš ï¸ BLEåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ");
    });

    server = await device.gatt.connect();
    service = await server.getPrimaryService(UART_SERVICE);

    txChar = await service.getCharacteristic(UART_TX);
    rxChar = await service.getCharacteristic(UART_RX);

    await txChar.startNotifications();
    txChar.addEventListener("characteristicvaluechanged", evt => {
      let value = new TextDecoder().decode(evt.target.value);
      log("ğŸ“¥ RX: " + value);
    });

    log("âœ… BLEæ¥ç¶šæˆåŠŸï¼");
  } catch (e) {
    log("âŒ BLEã‚¨ãƒ©ãƒ¼: " + e);
  }
};

// ===== ãƒœã‚¿ãƒ³é€ä¿¡ =====
document.querySelectorAll(".txbtn").forEach(btn => {
  btn.addEventListener("click", async () => {
    if (!rxChar) {
      log("âš ï¸ BLEæœªæ¥ç¶š");
      return;
    }
    let id = btn.dataset.id;
    try {
      await rxChar.writeValue(new TextEncoder().encode(id));
      log("ğŸ“¤ TX: BTN" + id);
    } catch (e) {
      log("âŒ é€ä¿¡ã‚¨ãƒ©ãƒ¼: " + e);
    }
  });
});
</script>

</body>
</html>
