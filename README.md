# M5ATOM-S3-CAN-KEY-PAD

2026/2/12
🚀 Update v4.9: Enhanced Stability & K-Meter Support
【新機能 / New Features】

1. K-Type Thermocouple Support (Exhaust Temp)
K型熱電対（M5Stack K-Meter Unit）による排気温度の取得に対応しました。

取得した温度データは、設定されたIDでリアルタイムにCANバスへ送信されます。

Webアプリ上にも現在の温度（℃）がリアルタイム表示され、モニタリングが可能です。

2. Configurable CAN IDs (Web App)
PCを使わず、スマホのWebアプリから直接CAN IDを変更・保存できるようになりました。

PAD ID: キーパッドのボタンスイッチ送信ID

KID (K-Meter ID): 排気温度データの送信ID

設定画面で任意のHEX（16進数）を入力し、「SET」ボタンを押すだけで即座に反映・保存されます。

【改善点 / Improvements】

3. NVS Stability (Manual Save / SET Button)
設定値の保存（NVS）に関する信頼性を根本から見直しました。

従来のスライダー操作による自動保存を廃止し、各ボタン設定ごとに**「SET」ボタン**を実装しました。

数値を入力後、「SET」を押すことで初めてフラッシュメモリ（NVS）に書き込まれます。

これにより、入力途中の誤送信や、フラッシュメモリへの書き込みエラーを完全に防止しました。

4. Sync Protection (Operation Block)
アプリ接続直後の設定同期（Sync）中にボタン操作を行うと、通信負荷により動作が不安定になる問題を解消しました。

接続直後の約1.5秒間、画面全体に**「⚙️ Syncing...」**というオーバーレイを表示し、操作を一時的にブロックします。

同期が完全に終了し、操作可能な状態になってからキーパッドが有効化されます。

5. State Persistence
走行中（ボタンがONの状態）にスマホアプリを再接続しても、ボタンが勝手にOFFにリセットされないようになりました。

アプリ接続時、M5Atom側の現在のステータス（ON/OFF）を優先してUIに反映します。

アプリが落ちたり再接続が必要になった場合でも、車の機能を停止させることなく復帰可能です。

【使い方 / How to Use】

CONNECT START をタップしてデバイスに接続します。

「Syncing...」の表示が消えるまで待ちます。

CAN ID設定: 設定画面（⚙️）上部の「PAD ID」「KID」に任意のIDを入力し、「SET」で保存します。

ボタン設定: 各ボタンの送信値（ON/OFF）を入力し、オレンジ色の「SET」ボタンを押して保存します。

保存完了後、M5AtomS3の電源を入れ直しても、設定したIDと数値が自動的に適用されます。

 2025/0207
* VER4.6より指紋認証機能追加　操作ボタンディレイ数値変更機能追加　テスト機能としてk熱電対ユニット温度 (GROVE PORT)CAN ID200にて送信



M5Atom S3を使用したCAN通信キーパッドシステムです。
Web Bluetooth APIを使用しているため、専用アプリのインストールは不要で、スマートフォンのブラウザから直接CAN信号を送信して機器を制御できます。

## 📱 Webアプリ (コントローラー)
以下のURLにアクセスして使用します。
https://gok555.github.io/M5ATOM-S3-CAN-KEY-PAD/

## 📂 ファームウェアの種類
用途に合わせて、以下のフォルダ内のプログラムをM5Atom S3に書き込んでください。

### 1. M5 ATOM S3 1M SPEED ONLY CAN
* **通信速度:** 1Mbps 固定
* 通信速度が決まっている場合や、シンプルな構成で使用する場合に適しています。

### 2. M5 ATOM S3 AUTO CAN SPEED ver
* **通信速度:** 自動切替 (500kbps / 1Mbps)
* 接続先のCAN通信速度に合わせて、**500kbps または 1Mbps のいずれかに**自動的に切り替わります。
* ※その他の速度には対応していませんのでご注意ください。

*
## ⚙️ 設定・カスタマイズ (Configuration)

### CAN IDについて
* デフォルトの送信CAN IDは **100** に設定されています。

### IDを変更する場合
送信IDを変更したい場合は、以下の**2箇所**のプログラム内の数値を書き換える必要があります。
プログラム内には該当箇所にメモ書き（コメント）が記載されていますので、そちらを参考に変更してください。

1. **Webブラウザアプリ側** (`index.html`)
2. **M5Atom S3側プログラム** (`.ino`ファイル)

> [!NOTE]
> 両方のIDが一致していないと、正しく通信（制御）ができませんのでご注意ください。

---

## 🛠 使用ハードウェア (Hardware Requirements)

### 1. メインコントローラー
* **M5Stack ATOM S3**
    * 本システムの核となるデバイスです。
    * ディスプレイにIPアドレスや接続ステータス、送信中のCAN IDなどを表示します。

### 2. CAN通信モジュール
* **M5Stack ATOM CAN BASE  (CSIS3050G)**
    * 絶縁型（CA-IS3050G搭載）です。
    * DC-DC絶縁電源を内蔵しており、車両からのノイズ干渉を防ぎ安全に通信できます。
      

### 3. 配線・その他
* **CANバス接続ケーブル:** 車両のOBDIIコネクタやCANライン(CAN High / CAN Low)への接続用
* **USB Type-Cケーブル:** 給電および書き込み用

## ⚡ 接続について
* **CAN High / Low:** 車両側のCAN H/Lに合わせて
